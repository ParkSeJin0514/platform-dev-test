# ============================================================================
# Terraform Plan on PR (Multi-Cloud: AWS / GCP)
# ============================================================================
# PR ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏ Ïãú ÏûêÎèôÏúºÎ°ú Terraform Plan Ïã§Ìñâ
# Plan Í≤∞Í≥ºÎ•º PR ÏΩîÎ©òÌä∏Î°ú ÌëúÏãú
# ============================================================================

name: Terraform Plan (PR)

on:
  pull_request:
    branches: [main]
    paths:
      - 'aws/**/*.tf'
      - 'aws/**/*.hcl'
      - 'gcp/**/*.tf'
      - 'gcp/**/*.hcl'

env:
  TF_VERSION: 1.9.0
  TG_VERSION: 0.54.0

  # AWS ÏÑ§Ï†ï
  AWS_REGION: ap-northeast-2

  # GCP ÏÑ§Ï†ï
  GCP_PROJECT_ID: kdt2-final-project-t1
  GCP_REGION: asia-northeast3
  GCP_WORKLOAD_IDENTITY_PROVIDER: projects/605820610222/locations/global/workloadIdentityPools/github-pool/providers/github-provider

# ÎèôÏãúÏóê ÌïòÎÇòÎßå Ïã§Ìñâ (PRÎ≥ÑÎ°ú Î∂ÑÎ¶¨)
concurrency:
  group: terraform-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Î≥ÄÍ≤ΩÎêú ÌÅ¥ÎùºÏö∞Îìú Í∞êÏßÄ
  # ============================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      aws-changed: ${{ steps.changes.outputs.aws }}
      gcp-changed: ${{ steps.changes.outputs.gcp }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed files
        id: changes
        run: |
          # PRÏóêÏÑú Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path')

          # AWS Î≥ÄÍ≤Ω ÌôïÏù∏
          if echo "$CHANGED_FILES" | grep -q "^aws/"; then
            echo "aws=true" >> $GITHUB_OUTPUT
            echo "‚úÖ AWS ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ"
          else
            echo "aws=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è AWS ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå"
          fi

          # GCP Î≥ÄÍ≤Ω ÌôïÏù∏
          if echo "$CHANGED_FILES" | grep -q "^gcp/"; then
            echo "gcp=true" >> $GITHUB_OUTPUT
            echo "‚úÖ GCP ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ"
          else
            echo "gcp=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è GCP ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  # ============================================
  # AWS Terraform Plan
  # ============================================
  terraform-plan-aws:
    name: 'AWS Plan'
    needs: [detect-changes]
    if: needs.detect-changes.outputs.aws-changed == 'true'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    defaults:
      run:
        working-directory: aws

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Create SSH Key
        run: |
          mkdir -p keys
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > keys/test.pub

      - name: Terraform Plan - Foundation
        id: plan-foundation
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd foundation
          echo "### AWS Foundation Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan - Compute
        id: plan-compute
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd compute
          echo "### AWS Compute Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan - Bootstrap
        id: plan-bootstrap
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd bootstrap
          echo "### AWS Bootstrap Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Post Plan Result to PR
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### üîç AWS Terraform Plan Í≤∞Í≥º

            | Layer | Status |
            |-------|--------|
            | Foundation | ${{ steps.plan-foundation.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
            | Compute | ${{ steps.plan-compute.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
            | Bootstrap | ${{ steps.plan-bootstrap.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |

            üìã ÏÉÅÏÑ∏ Í≤∞Í≥ºÎäî [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.

            > Merge Ïãú **Terraform Apply**Í∞Ä ÏûêÎèô Ïã§ÌñâÎê©ÎãàÎã§.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================
  # GCP Terraform Plan
  # ============================================
  terraform-plan-gcp:
    name: 'GCP Plan'
    needs: [detect-changes]
    if: needs.detect-changes.outputs.gcp-changed == 'true'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    defaults:
      run:
        working-directory: gcp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: github-actions@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Terraform Plan - Foundation
        id: plan-foundation
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd foundation
          echo "### GCP Foundation Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan - Compute
        id: plan-compute
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd compute
          echo "### GCP Compute Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan - Bootstrap
        id: plan-bootstrap
        continue-on-error: true
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          cd bootstrap
          echo "### GCP Bootstrap Plan" >> $GITHUB_STEP_SUMMARY
          terragrunt plan --terragrunt-non-interactive -no-color 2>&1 | tee plan-output.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Post Plan Result to PR
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### üîç GCP Terraform Plan Í≤∞Í≥º

            | Layer | Status |
            |-------|--------|
            | Foundation | ${{ steps.plan-foundation.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
            | Compute | ${{ steps.plan-compute.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |
            | Bootstrap | ${{ steps.plan-bootstrap.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |

            üìã ÏÉÅÏÑ∏ Í≤∞Í≥ºÎäî [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.

            > Merge Ïãú **Terraform Apply**Í∞Ä ÏûêÎèô Ïã§ÌñâÎê©ÎãàÎã§.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================
  # Slack ÏïåÎ¶º - PR Plan ÏôÑÎ£å
  # ============================================
  notify-slack:
    name: Notify Slack
    needs: [detect-changes, terraform-plan-aws, terraform-plan-gcp]
    if: always() && (needs.terraform-plan-aws.result != 'skipped' || needs.terraform-plan-gcp.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üîç Terraform Plan ÏôÑÎ£å - PR Î¶¨Î∑∞ ÌïÑÏöî",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*PR:*\n#${{ github.event.pull_request.number }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*AWS Plan:*\n${{ needs.terraform-plan-aws.result == 'success' && '‚úÖ Success' || needs.terraform-plan-aws.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*GCP Plan:*\n${{ needs.terraform-plan-gcp.result == 'success' && '‚úÖ Success' || needs.terraform-plan-gcp.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Title:*\n${{ github.event.pull_request.title }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "PR Î¶¨Î∑∞ÌïòÎü¨ Í∞ÄÍ∏∞",
                        "emoji": true
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
