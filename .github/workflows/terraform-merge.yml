# ============================================================================
# Terraform Apply on Merge (Multi-Cloud: AWS / GCP)
# ============================================================================
# PRÏù¥ main Î∏åÎûúÏπòÏóê MergeÎê† Îïå ÏûêÎèôÏúºÎ°ú Terraform Apply Ïã§Ìñâ
# PR Approve = ÏäπÏù∏ (Î≥ÑÎèÑ Environment ÏäπÏù∏ Î∂àÌïÑÏöî)
# ============================================================================

name: Terraform Apply (Merge)

on:
  push:
    branches: [main]
    paths:
      - 'aws/**/*.tf'
      - 'aws/**/*.hcl'
      - 'gcp/**/*.tf'
      - 'gcp/**/*.hcl'

env:
  TF_VERSION: 1.9.0
  TG_VERSION: 0.54.0

  # AWS ÏÑ§Ï†ï
  AWS_REGION: ap-northeast-2

  # GCP ÏÑ§Ï†ï
  GCP_PROJECT_ID: kdt2-final-project-t1
  GCP_REGION: asia-northeast3
  GCP_WORKLOAD_IDENTITY_PROVIDER: projects/605820610222/locations/global/workloadIdentityPools/github-pool/providers/github-provider

# ÎèôÏãúÏóê ÌïòÎÇòÎßå Ïã§Ìñâ
concurrency:
  group: terraform-merge
  cancel-in-progress: false

jobs:
  # ============================================
  # Î≥ÄÍ≤ΩÎêú ÌÅ¥ÎùºÏö∞Îìú Í∞êÏßÄ
  # ============================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      aws-changed: ${{ steps.changes.outputs.aws }}
      gcp-changed: ${{ steps.changes.outputs.gcp }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          # Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµêÌïòÏó¨ Î≥ÄÍ≤ΩÎêú ÌååÏùº ÌôïÏù∏
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          echo "Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù:"
          echo "$CHANGED_FILES"

          # AWS Î≥ÄÍ≤Ω ÌôïÏù∏
          if echo "$CHANGED_FILES" | grep -q "^aws/"; then
            echo "aws=true" >> $GITHUB_OUTPUT
            echo "‚úÖ AWS ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ"
          else
            echo "aws=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è AWS ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå"
          fi

          # GCP Î≥ÄÍ≤Ω ÌôïÏù∏
          if echo "$CHANGED_FILES" | grep -q "^gcp/"; then
            echo "gcp=true" >> $GITHUB_OUTPUT
            echo "‚úÖ GCP ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ"
          else
            echo "gcp=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è GCP ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå"
          fi

  # ============================================
  # Slack ÏïåÎ¶º - Apply ÏãúÏûë
  # ============================================
  notify-start:
    name: Notify Start
    needs: [detect-changes]
    if: needs.detect-changes.outputs.aws-changed == 'true' || needs.detect-changes.outputs.gcp-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification - Start
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Terraform Apply ÏãúÏûë (PR Merge)",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*AWS:*\n${{ needs.detect-changes.outputs.aws-changed == 'true' && '‚úÖ Apply ÏòàÏ†ï' || '‚è≠Ô∏è Î≥ÄÍ≤Ω ÏóÜÏùå' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*GCP:*\n${{ needs.detect-changes.outputs.gcp-changed == 'true' && '‚úÖ Apply ÏòàÏ†ï' || '‚è≠Ô∏è Î≥ÄÍ≤Ω ÏóÜÏùå' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Ïã§ÌñâÏûê:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î≥¥Í∏∞",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # AWS Terraform Apply
  # ============================================
  terraform-apply-aws:
    name: 'AWS Apply'
    needs: [detect-changes, notify-start]
    if: needs.detect-changes.outputs.aws-changed == 'true'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: aws

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Create SSH Key
        run: |
          mkdir -p keys
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > keys/test.pub

      - name: Apply Foundation
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üèóÔ∏è Foundation Layer Apply ÏãúÏûë..."
          cd foundation && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Foundation Layer ÏôÑÎ£å"

      - name: Apply Compute
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üñ•Ô∏è Compute Layer Apply ÏãúÏûë..."
          cd compute && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Compute Layer ÏôÑÎ£å"

      - name: Apply Bootstrap
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üöÄ Bootstrap Layer Apply ÏãúÏûë..."
          cd bootstrap && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Bootstrap Layer ÏôÑÎ£å"

  # ============================================
  # GCP Terraform Apply
  # ============================================
  terraform-apply-gcp:
    name: 'GCP Apply'
    needs: [detect-changes, notify-start]
    if: needs.detect-changes.outputs.gcp-changed == 'true'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: gcp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: github-actions@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Get GKE credentials (if exists)
        continue-on-error: true
        run: |
          if gcloud container clusters describe petclinic-dr-gke --region ${{ env.GCP_REGION }} --project ${{ env.GCP_PROJECT_ID }} 2>/dev/null; then
            gcloud container clusters get-credentials petclinic-dr-gke \
              --region ${{ env.GCP_REGION }} \
              --project ${{ env.GCP_PROJECT_ID }}
          fi

      - name: Apply Foundation
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üèóÔ∏è Foundation Layer Apply ÏãúÏûë..."
          cd foundation && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Foundation Layer ÏôÑÎ£å"

      - name: Apply Compute
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üñ•Ô∏è Compute Layer Apply ÏãúÏûë..."
          cd compute && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Compute Layer ÏôÑÎ£å"

      - name: Get GKE credentials after Compute
        continue-on-error: true
        run: |
          echo "üîë GKE Ïù∏Ï¶ù ÏÑ§Ï†ï..."
          gcloud container clusters get-credentials petclinic-dr-gke \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Apply Bootstrap
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "üöÄ Bootstrap Layer Apply ÏãúÏûë..."
          cd bootstrap && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "‚úÖ Bootstrap Layer ÏôÑÎ£å"

  # ============================================
  # Slack ÏïåÎ¶º - ÏôÑÎ£å
  # ============================================
  notify-complete:
    name: Notify Complete
    needs: [detect-changes, terraform-apply-aws, terraform-apply-gcp]
    if: always() && (needs.terraform-apply-aws.result != 'skipped' || needs.terraform-apply-gcp.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Determine overall result
        id: result
        run: |
          AWS_RESULT="${{ needs.terraform-apply-aws.result }}"
          GCP_RESULT="${{ needs.terraform-apply-gcp.result }}"

          if [[ "$AWS_RESULT" == "failure" ]] || [[ "$GCP_RESULT" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "text=Terraform Apply Ïã§Ìå®" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "text=Terraform Apply ÏÑ±Í≥µ" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification - Complete
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.result.outputs.emoji }} ${{ steps.result.outputs.text }} (PR Merge)",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*AWS:*\n${{ needs.terraform-apply-aws.result == 'success' && '‚úÖ Success' || needs.terraform-apply-aws.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*GCP:*\n${{ needs.terraform-apply-gcp.result == 'success' && '‚úÖ Success' || needs.terraform-apply-gcp.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Ïã§ÌñâÏûê:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ÏÉÅÏÑ∏ Î°úÍ∑∏ Î≥¥Í∏∞",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
