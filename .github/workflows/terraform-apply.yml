# ============================================================================
# Terraform Apply (Multi-Cloud: AWS / GCP)
# ============================================================================
# ìˆ˜ë™ ì‹¤í–‰ìœ¼ë¡œ í´ë¼ìš°ë“œì™€ ë ˆì´ì–´ ì„ íƒí•˜ì—¬ Apply
# - cloud: aws / gcp
# - layer: all / foundation / compute / bootstrap
# ============================================================================

name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: 'í´ë¼ìš°ë“œ ì„ íƒ'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - gcp
      layer:
        description: 'ì ìš©í•  ë ˆì´ì–´ ì„ íƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - foundation
          - compute
          - bootstrap

env:
  TF_VERSION: 1.9.0
  TG_VERSION: 0.54.0

  # AWS ì„¤ì •
  AWS_REGION: ap-northeast-2

  # GCP ì„¤ì •
  GCP_PROJECT_ID: kdt2-final-project-t1
  GCP_REGION: asia-northeast3
  GCP_WORKLOAD_IDENTITY_PROVIDER: projects/605820610222/locations/global/workloadIdentityPools/github-pool/providers/github-provider

  # Slack
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ë™ì‹œì— í•˜ë‚˜ë§Œ ì‹¤í–‰ (í´ë¼ìš°ë“œë³„ë¡œ ë¶„ë¦¬)
# âš ï¸ DynamoDB Lock í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬
# concurrency:
#   group: terraform-apply-${{ github.event.inputs.cloud }}
#   cancel-in-progress: false

jobs:
  # ============================================
  # Slack ì•Œë¦¼ - ì‹œì‘
  # ============================================
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification - Start
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ Terraform Apply ì‹œì‘",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Cloud:*\n${{ github.event.inputs.cloud }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Layer:*\n${{ github.event.inputs.layer }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì‹¤í–‰ì:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ì›Œí¬í”Œë¡œìš° ë³´ê¸°",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # Terraform Apply
  # ============================================
  apply:
    name: Terraform Apply (${{ github.event.inputs.cloud }}/${{ github.event.inputs.layer }})
    runs-on: ubuntu-latest

    # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: ${{ github.event.inputs.cloud }}

    steps:
      # ========================================
      # 1. ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout
        uses: actions/checkout@v4

      # ========================================
      # 2. AWS ì¸ì¦ (AWS ì„ íƒ ì‹œ)
      # ========================================
      - name: Configure AWS credentials
        if: github.event.inputs.cloud == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ========================================
      # 3. GCP ì¸ì¦ (GCP ì„ íƒ ì‹œ)
      # ========================================
      - name: Authenticate to Google Cloud
        if: github.event.inputs.cloud == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: github-actions@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        if: github.event.inputs.cloud == 'gcp'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # ========================================
      # 4. Terraform ì„¤ì¹˜
      # ========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      # ========================================
      # 5. Terragrunt ì„¤ì¹˜
      # ========================================
      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      # ========================================
      # 6. SSH Key ìƒì„± (AWS ì „ìš©)
      # ========================================
      - name: Create SSH Key
        if: github.event.inputs.cloud == 'aws'
        run: |
          mkdir -p keys
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > keys/test.pub

      # ========================================
      # 7. GKE ì¸ì¦ (GCP Bootstrap ì‹œ)
      # ========================================
      - name: Get GKE credentials
        if: github.event.inputs.cloud == 'gcp' && (github.event.inputs.layer == 'bootstrap' || github.event.inputs.layer == 'all')
        run: |
          # Computeê°€ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ GKE ì¸ì¦ ì‹œë„
          if gcloud container clusters describe petclinic-dr-gke --region ${{ env.GCP_REGION }} --project ${{ env.GCP_PROJECT_ID }} 2>/dev/null; then
            gcloud container clusters get-credentials petclinic-dr-gke \
              --region ${{ env.GCP_REGION }} \
              --project ${{ env.GCP_PROJECT_ID }}
          else
            echo "GKE cluster not found, skipping credentials setup"
          fi

      # ========================================
      # 8. Apply Foundation
      # ========================================
      - name: Apply Foundation
        if: github.event.inputs.layer == 'all' || github.event.inputs.layer == 'foundation'
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "ğŸ—ï¸ Foundation Layer Apply ì‹œì‘..."
          cd foundation && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "âœ… Foundation Layer ì™„ë£Œ"

      # ========================================
      # 9. Apply Compute
      # ========================================
      - name: Apply Compute
        if: github.event.inputs.layer == 'all' || github.event.inputs.layer == 'compute'
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "ğŸ–¥ï¸ Compute Layer Apply ì‹œì‘..."
          cd compute && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "âœ… Compute Layer ì™„ë£Œ"

      # ========================================
      # 10. GKE ì¸ì¦ (Compute ì™„ë£Œ í›„ Bootstrap ì „)
      # ========================================
      - name: Get GKE credentials after Compute
        if: github.event.inputs.cloud == 'gcp' && github.event.inputs.layer == 'all'
        run: |
          echo "ğŸ”‘ GKE ì¸ì¦ ì„¤ì •..."
          gcloud container clusters get-credentials petclinic-dr-gke \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}
          echo "âœ… GKE ì¸ì¦ ì™„ë£Œ"

      # ========================================
      # 11. Apply Bootstrap
      # ========================================
      - name: Apply Bootstrap
        if: github.event.inputs.layer == 'all' || github.event.inputs.layer == 'bootstrap'
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          echo "ğŸš€ Bootstrap Layer Apply ì‹œì‘..."
          cd bootstrap && terragrunt apply --terragrunt-non-interactive -auto-approve
          echo "âœ… Bootstrap Layer ì™„ë£Œ"

      # ========================================
      # 12. ì™„ë£Œ ë©”ì‹œì§€
      # ========================================
      - name: Apply Complete
        run: |
          echo "=============================================="
          echo "ğŸ‰ Terraform Apply ì™„ë£Œ!"
          echo "=============================================="
          echo "Cloud: ${{ github.event.inputs.cloud }}"
          echo "Layer: ${{ github.event.inputs.layer }}"

  # ============================================
  # Slack ì•Œë¦¼ - ì™„ë£Œ
  # ============================================
  notify-complete:
    needs: [apply]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification - Complete
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.apply.result == 'success' && 'âœ… Terraform Apply ì„±ê³µ' || 'âŒ Terraform Apply ì‹¤íŒ¨' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Cloud:*\n${{ github.event.inputs.cloud }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Layer:*\n${{ github.event.inputs.layer }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ê²°ê³¼:*\n${{ needs.apply.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‹¤í–‰ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ìƒì„¸ ë¡œê·¸ ë³´ê¸°",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
